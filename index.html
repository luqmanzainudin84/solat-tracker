<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
body{font-family:system-ui;background:#f2f2f2;margin:0}
.container{max-width:420px;margin:auto;padding:12px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px}
.row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
.row:last-child{border-bottom:none}
.pill{padding:6px 14px;border-radius:20px;color:#fff;font-size:14px;cursor:pointer}
.grey{background:#aaa}
.yellow{background:#f1c40f;color:#000}
.red{background:#e74c3c}
.green{background:#2ecc71}
.gold{background:#f39c12;color:#000}

/* Popup */
#popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center}
#popup.hidden{display:none}
.popup-box{background:#fff;border-radius:14px;padding:18px;width:90%;max-width:300px}

/* Heatmap */
.heat-wrap{overflow-x:auto}
.heat-grid{display:grid;grid-template-rows:repeat(5,32px);grid-auto-columns:32px;grid-auto-flow:column;gap:6px}
.heat-cell{width:32px;height:32px;border-radius:6px}
.label-col{display:grid;grid-template-rows:repeat(5,32px);gap:6px;font-size:13px;padding-right:6px}

/* Debug */
#debug{background:#000;color:#0f0;font-family:monospace;font-size:12px;height:140px;overflow:auto;padding:8px;border-radius:10px}
</style>
</head>

<body>
<div class="container">

<h2>Solat Tracker</h2>
<div id="dateText"></div>

<div class="card" id="daily"></div>

<div class="card">
<h3>Heatmap Solat</h3>
<div style="display:flex">
<div class="label-col">
<div>Subuh</div><div>Zohor</div><div>Asar</div><div>Maghrib</div><div>Isyak</div>
</div>
<div class="heat-wrap">
<div id="heatmap" class="heat-grid"></div>
</div>
</div>
</div>

<div id="popup" class="hidden">
<div class="popup-box">
<h3 id="popupTitle"></h3>
<button onclick="submit(0)" class="pill red">Tak</button>
<button onclick="submit(1)" class="pill yellow">Lewat</button>
<button onclick="submit(2)" class="pill green">Awal</button>
<button onclick="submit(3)" class="pill gold">Jemaah</button>
<br><br>
<button onclick="closePopup()">Cancel</button>
</div>
</div>

<div class="container">
<h3>Debug</h3>
<div id="debug"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwHxXrDrvBx27NbzEeevxIkKYTVVrdEsxV83xxpO9lKHltN3SmvCiiAR3daFTmiJt2k/exec";
let selectedSolat=null;
let currentDate=new Date().toISOString().slice(0,10);

function log(t){debug.innerHTML+=`[${new Date().toLocaleTimeString()}] ${t}<br>`}

function openPopup(s){selectedSolat=s;popupTitle.textContent=s.toUpperCase();popup.classList.remove("hidden")}
function closePopup(){popup.classList.add("hidden")}

async function submit(val){
log(`POST ${selectedSolat}=${val}`);
const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({date:currentDate,solat:selectedSolat,value:val})});
const j=await res.json();
if(j.status==="updated"){
closePopup();
await loadDetail();
await loadHeatmap();
}else log("ERROR update");
}

async function loadDetail(){
log("loadDetail");
const d=await fetch(`${API}?mode=detail&date=${currentDate}`).then(r=>r.json());
daily.innerHTML="";
["subuh","zohor","asar","maghrib","isyak"].forEach(k=>{
const map=["grey","yellow","green","gold"];
daily.innerHTML+=`<div class="row"><div>${k}</div>
<div class="pill ${map[d[k]||0]}" onclick="openPopup('${k}')">${["Belum","Lewat","Awal","Jemaah"][d[k]||0]}</div></div>`;
});
}

async function loadHeatmap(){
log("loadHeatmap");
const data=await fetch(`${API}?mode=summary`).then(r=>r.json());
heatmap.innerHTML="";
data.days.forEach(d=>{
for(let i=0;i<5;i++){
const c=document.createElement("div");
c.className="heat-cell "+["grey","yellow","green","gold"][d.status||0];
heatmap.appendChild(c);
}
});
}

async function init(){
dateText.textContent=currentDate;
await loadDetail();
await loadHeatmap();
}
init();
</script>
</body>
</html>
