<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Solat Tracker</title>

<style>
body{margin:0;font-family:system-ui;background:#f3f3f3}
.container{max-width:430px;margin:auto;padding:16px}
h1{text-align:center;margin-bottom:4px}
.subtitle{text-align:center;color:#666;margin-bottom:16px}

.card{
  background:#fff;border-radius:16px;padding:14px;
  margin-bottom:14px;box-shadow:0 2px 10px rgba(0,0,0,.1)
}

.row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
.row:last-child{border-bottom:none}

.pill{padding:6px 14px;border-radius:999px;color:#fff;font-size:14px;cursor:pointer}
.red{background:#e53935}
.yellow{background:#fbc02d;color:#000}
.green{background:#43a047}
.gold{background:#fdd835;color:#000}
.grey{background:#9e9e9e}

/* ================= HEATMAP ================= */

.hm-card{
  background:#fff;border-radius:16px;padding:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.1)
}
.hm-title{font-weight:800;margin-bottom:8px}
.hm-scroll{overflow-x:auto}

.hm-wrapper{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:48px;
  gap:10px;
}

/* kotak tarikh */
.hm-dow{
  font-size:11px;
  font-weight:700;
  text-align:center;
  background:#ececec;
  border-radius:6px;
  padding:2px 0;
}
.hm-day{
  font-size:14px;
  font-weight:800;
  text-align:center;
}

/* kolum solat */
.hm-col{
  display:grid;
  grid-template-rows:repeat(5,26px);
  gap:6px;
}
.hm-cell{border-radius:6px;background:#e0e0e0}
.hm-cell.red{background:#e53935}
.hm-cell.yellow{background:#fbc02d}
.hm-cell.green{background:#43a047}
.hm-cell.gold{
  background:#43a047;position:relative
}
.hm-cell.gold::after{
  content:"";
  position:absolute;left:4px;right:4px;bottom:3px;
  height:3px;background:#fdd835;border-radius:99px
}

.debug{
  margin-top:10px;background:#000;color:#0f0;
  font-family:monospace;font-size:12px;
  padding:8px;border-radius:10px
}
</style>
</head>

<body>
<div class="container">
  <h1>Solat Tracker</h1>
  <div class="subtitle" id="fullDate"></div>

  <!-- Status Harian -->
  <div class="card" id="dailyCard"></div>

  <!-- Heatmap -->
  <div class="hm-card">
    <div class="hm-title">Ringkasan Solat</div>
    <div class="hm-scroll">
      <div class="hm-wrapper" id="heatmap"></div>
    </div>
  </div>

  <div class="debug" id="debug"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";
const PRAYERS=["subuh","zohor","asar","maghrib","isyak"];
const DOW=["Ahd","Isn","Sel","Rab","Kha","Jum","Sab"];

let todayISO=new Date().toISOString().slice(0,10);

function log(m){debug.innerHTML+=`[${new Date().toLocaleTimeString()}] ${m}<br>`}
function cls(v){return["red","yellow","green","gold","grey"][v]}

async function loadDay(){
  const r=await fetch(API+`?mode=detail&date=${todayISO}`);
  const d=await r.json();
  dailyCard.innerHTML=`<b>Status Harian</b><br><small>Tarikh: ${todayISO}</small>`;
  PRAYERS.forEach(p=>{
    const v=d[p]??4;
    dailyCard.innerHTML+=`
      <div class="row">
        <span>${p[0].toUpperCase()+p.slice(1)}</span>
        <span class="pill ${cls(v)}">${["Tak","Lewat","Awal","Jemaah","Belum"][v]}</span>
      </div>`;
  });
}

async function loadHeatmap(){
  heatmap.innerHTML="";
  const now=new Date();
  const y=now.getFullYear(),m=now.getMonth();
  const days=new Date(y,m+1,0).getDate();

  for(let d=1;d<=days;d++){
    const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dateObj=new Date(iso);

    const r=await fetch(API+`?mode=detail&date=${iso}`);
    const day=await r.json();

    const col=document.createElement("div");

    const dow=document.createElement("div");
    dow.className="hm-dow";
    dow.innerText=DOW[dateObj.getDay()];

    const dayBox=document.createElement("div");
    dayBox.className="hm-day";
    dayBox.innerText=d;

    const stack=document.createElement("div");
    stack.className="hm-col";

    PRAYERS.forEach(p=>{
      const c=document.createElement("div");
      c.className="hm-cell "+cls(day[p]??4);
      stack.appendChild(c);
    });

    col.appendChild(dow);
    col.appendChild(dayBox);
    col.appendChild(stack);
    heatmap.appendChild(col);
  }
}

fullDate.innerText=new Date().toLocaleDateString("ms-MY",
  {weekday:"long",day:"numeric",month:"long",year:"numeric"}
);

loadDay();
loadHeatmap();
log("Ready");
</script>
</body>
</html>