<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
body{margin:0;font-family:system-ui;background:#f4f4f4}
.container{max-width:420px;margin:auto;padding:16px}
h1{text-align:center;margin-bottom:4px}
.date-text{text-align:center;color:#555;margin-bottom:10px}

.card,.hm-card{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:12px;margin-bottom:14px}
.row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
.row:last-child{border-bottom:none}

.pill{padding:6px 14px;border-radius:999px;color:#fff;font-size:14px;cursor:pointer}
.grey{background:#9e9e9e}
.red{background:#e53935}
.yellow{background:#fbc02d;color:#000}
.green{background:#43a047}
.gold{background:#fdd835;color:#000}

input[type=date]{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc}

.popup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9}
.hidden{display:none}
.popup-box{background:#fff;width:85%;max-width:320px;padding:16px;border-radius:16px}
.popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{padding:12px;border:none;border-radius:12px;font-weight:700}
.cancel{margin-top:10px;width:100%}

.hm-scroll{overflow-x:auto}
.hm-grid{display:grid;grid-auto-flow:column;grid-auto-columns:28px;grid-template-rows:repeat(5,28px);gap:6px}
.hm-cell{width:28px;height:28px;border-radius:6px;background:#e0e0e0}

.debug{background:#000;color:#0f0;font-family:monospace;font-size:12px;padding:8px;border-radius:10px;max-height:120px;overflow:auto}
</style>
</head>

<body>
<div class="container">
  <h1>Solat Tracker</h1>
  <div class="date-text" id="todayText"></div>

  <input type="date" id="datePicker">

  <div class="card" id="daily"></div>

  <div class="hm-card">
    <b>Ringkasan Solat</b><br>
    <small id="hmDate"></small>
    <div class="hm-scroll">
      <div class="hm-grid" id="heatmap"></div>
    </div>
  </div>

  <div class="debug" id="debug"></div>
</div>

<div class="popup hidden" id="popup">
  <div class="popup-box">
    <h3 id="popupTitle"></h3>
    <div class="popup-grid">
      <button class="btn red" onclick="submit(0)">Tak Solat</button>
      <button class="btn yellow" onclick="submit(1)">Lewat</button>
      <button class="btn green" onclick="submit(2)">Awal</button>
      <button class="btn gold" onclick="submit(3)">Jemaah</button>
    </div>
    <button class="cancel" onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";
const PRAYERS=["subuh","zohor","asar","maghrib","isyak"];
let selectedSolat=null;
let date=today();

function log(m){debug.innerHTML+=`[${new Date().toLocaleTimeString()}] ${m}<br>`}

function today(){return new Date().toISOString().slice(0,10)}
function cls(v){return["red","yellow","green","gold","grey"][v]}
function lbl(v){return["Tak","Lewat","Awal","Jemaah","Belum"][v]}

function openPopup(s){selectedSolat=s;popupTitle.innerText=s.toUpperCase();popup.classList.remove("hidden")}
function closePopup(){popup.classList.add("hidden")}

async function submit(v){
  log(`POST ${selectedSolat}=${v}`);
  await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date,solat:selectedSolat,value:v})});
  closePopup();
  loadDay();
}

async function loadDay(){
  log("Load day "+date);
  const r=await fetch(API+`?mode=detail&date=${date}`);
  const d=await r.json();
  daily.innerHTML="";
  heatmap.innerHTML="";
  hmDate.innerText="Tarikh: "+date;

  PRAYERS.forEach(p=>{
    const v=d[p]??4;
    daily.innerHTML+=`
      <div class="row">
        <span>${p[0].toUpperCase()+p.slice(1)}</span>
        <span class="pill ${cls(v)}" onclick="openPopup('${p}')">${lbl(v)}</span>
      </div>`;
    heatmap.innerHTML+=`<div class="hm-cell ${cls(v)}"></div>`;
  });
}

datePicker.value=date;
datePicker.onchange=e=>{date=e.target.value;loadDay()}

todayText.innerText=new Date().toLocaleDateString("ms-MY",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
loadDay();
log("App ready");
</script>
</body>
</html>