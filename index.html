<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
body { font-family: Arial; background:#f2f2f2; margin:0 }
.container { max-width:420px; margin:20px auto; padding:10px }
h2,h3 { text-align:center }

.card { background:#fff; padding:12px; border-radius:10px }
.row { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee }
.row:last-child { border-bottom:none }

.pill { padding:6px 14px; border-radius:12px; color:#fff; cursor:pointer }
.grey{background:#9e9e9e}
.red{background:#e53935}
.yellow{background:#fbc02d;color:#000}
.green{background:#43a047}
.gold{background:#fdd835;color:#000}

.popup {
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:flex; justify-content:center; align-items:center;
}
.hidden{display:none}
.box{background:#fff;padding:15px;border-radius:10px;width:90%;max-width:340px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
button{padding:10px;border:none;border-radius:8px;font-size:14px;cursor:pointer}
.cancel{margin-top:10px;width:100%;background:#ccc}

input[type="date"]{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

/* DEBUG */
.debug{
  margin-top:15px;
  background:#111;
  color:#0f0;
  padding:8px;
  font-size:11px;
  border-radius:6px;
  max-height:160px;
  overflow-y:auto;
}
</style>
</head>

<body>
<div class="container">
  <h2>Solat Tracker</h2>
  <div id="prettyDate" style="text-align:center;margin-bottom:8px"></div>

  <input type="date" id="datePicker">

  <div class="card">
    <div class="row"><span>Subuh</span><span id="subuh" class="pill grey" onclick="openP('subuh')">Belum</span></div>
    <div class="row"><span>Zohor</span><span id="zohor" class="pill grey" onclick="openP('zohor')">Belum</span></div>
    <div class="row"><span>Asar</span><span id="asar" class="pill grey" onclick="openP('asar')">Belum</span></div>
    <div class="row"><span>Maghrib</span><span id="maghrib" class="pill grey" onclick="openP('maghrib')">Belum</span></div>
    <div class="row"><span>Isyak</span><span id="isyak" class="pill grey" onclick="openP('isyak')">Belum</span></div>
  </div>

  <h3>Debug Log</h3>
  <div id="debug" class="debug"></div>
</div>

<div id="popup" class="popup hidden">
  <div class="box">
    <h3 id="title"></h3>
    <div class="grid">
      <button class="red" onclick="setVal(0)">✖ Tak Solat</button>
      <button class="yellow" onclick="setVal(1)">⏱ Lewat</button>
      <button class="green" onclick="setVal(2)">✔ Awal</button>
      <button class="gold" onclick="setVal(3)">⭐ Jemaah</button>
    </div>
    <button class="cancel" onclick="closeP()">Cancel</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";

const labels=["Tak Solat","Lewat","Awal","Jemaah","Belum"];
const colors=["red","yellow","green","gold","grey"];

let solat=null;
let date=new Date().toISOString().slice(0,10);

const debugBox=document.getElementById("debug");
function log(msg){
  debugBox.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  debugBox.scrollTop = debugBox.scrollHeight;
}

function pretty(d){
  document.getElementById("prettyDate").innerText =
    new Date(d).toLocaleDateString("ms-MY",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}

function updateP(s,v){
  const el=document.getElementById(s);
  el.textContent=labels[v];
  el.className="pill "+colors[v];
}

function openP(s){
  solat=s;
  title.innerText=s.toUpperCase()+" — "+date;
  popup.classList.remove("hidden");
  log("openPopup "+s);
}
function closeP(){
  popup.classList.add("hidden");
  log("closePopup");
}

async function setVal(v){
  log(`update ${solat}=${v}`);
  const url=`${API}?mode=update&date=${date}&solat=${solat}&value=${v}`;
  const r=await fetch(url);
  const t=await r.text();
  log("API: "+t);
  updateP(solat,v);
  closeP();
}

async function loadDay(d){
  log("loadDay "+d);
  const r=await fetch(`${API}?mode=detail&date=${d}`);
  const data=await r.json();
  ["subuh","zohor","asar","maghrib","isyak"].forEach(s=>updateP(s,data[s]));
}

document.getElementById("datePicker").value=date;
document.getElementById("datePicker").addEventListener("change",e=>{
  date=e.target.value;
  pretty(date);
  loadDay(date);
});

pretty(date);
loadDay(date);
log("JS loaded OK");
</script>
</body>
</html>
