<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Solat Tracker</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 16px;
}

h1 {
  text-align: center;
  margin-bottom: 4px;
}

.subtitle {
  text-align: center;
  color: #666;
  margin-bottom: 12px;
}

.card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}
.row:last-child { border-bottom: none; }

.pill {
  padding: 6px 14px;
  border-radius: 20px;
  color: #fff;
  font-size: 14px;
}

.grey { background: #aaa; }
.yellow { background: #f1c40f; color:#000; }
.green { background: #2ecc71; }
.red { background: #e74c3c; }

.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: flex;
  align-items: center;
  justify-content: center;
}
.popup.hidden { display: none; }

.popup-box {
  background: #fff;
  padding: 16px;
  border-radius: 16px;
  width: 90%;
  max-width: 320px;
}

.popup-box h3 {
  text-align: center;
  margin-top: 0;
}

.popup-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.popup-grid button {
  border: none;
  border-radius: 12px;
  padding: 10px;
  font-size: 14px;
  color: #fff;
}

.cancel {
  margin-top: 12px;
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
}

.heatmap-wrapper {
  overflow-x: auto;
}

.heatmap {
  display: grid;
  grid-template-columns: 60px repeat(auto-fit, 32px);
  gap: 6px;
  min-width: 600px;
}

.hm-label {
  font-size: 13px;
  align-self: center;
}

.hm-cell {
  width: 28px;
  height: 28px;
  border-radius: 6px;
}

.debug {
  background: #000;
  color: #0f0;
  padding: 8px;
  font-family: monospace;
  font-size: 11px;
  max-height: 140px;
  overflow-y: auto;
}
</style>
</head>

<body>

<h1>Solat Tracker</h1>
<div class="subtitle" id="todayLabel"></div>

<div class="card" id="dailyCard"></div>

<div class="card">
  <h3>Heatmap Solat</h3>
  <div class="heatmap-wrapper">
    <div id="heatmap" class="heatmap"></div>
  </div>
</div>

<div class="card">
  <b>Debug</b>
  <div id="debug" class="debug"></div>
</div>

<!-- POPUP -->
<div id="popup" class="popup hidden">
  <div class="popup-box">
    <h3 id="popupTitle"></h3>
    <div class="popup-grid">
      <button class="red" onclick="submit(0)">Tak</button>
      <button class="yellow" onclick="submit(1)">Lewat</button>
      <button class="green" onclick="submit(2)">Awal</button>
      <button class="yellow" onclick="submit(3)">Jemaah</button>
    </div>
    <button class="cancel" onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";

const PRAYERS = ["subuh","zohor","asar","maghrib","isyak"];
const LABEL = ["Tak","Lewat","Awal","Jemaah","Belum"];
const COLOR = ["red","yellow","green","yellow","grey"];

let selectedDate = new Date().toISOString().slice(0,10);
let selectedPrayer = null;
let localData = {};

function log(msg){
  const d = document.getElementById("debug");
  d.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  d.scrollTop = d.scrollHeight;
}

function renderDaily(){
  const card = document.getElementById("dailyCard");
  card.innerHTML = `<b>Status Harian</b><br>Tarikh: ${selectedDate}<br><br>`;
  PRAYERS.forEach(p=>{
    const v = localData[p] ?? 4;
    card.innerHTML += `
      <div class="row">
        <span>${p.charAt(0).toUpperCase()+p.slice(1)}</span>
        <span class="pill ${COLOR[v]}" onclick="openPopup('${p}')">${LABEL[v]}</span>
      </div>
    `;
  });
}

function openPopup(p){
  selectedPrayer = p;
  document.getElementById("popupTitle").innerText = p.toUpperCase();
  document.getElementById("popup").classList.remove("hidden");
}

function closePopup(){
  document.getElementById("popup").classList.add("hidden");
}

async function submit(value){
  // UPDATE UI TERUS (INI FIX UTAMA)
  localData[selectedPrayer] = value;
  renderDaily();
  closePopup();
  log(`Local update ${selectedPrayer}=${value}`);

  // POST BACKGROUND (NO REFETCH)
  await fetch(API,{
    method:"POST",
    body: JSON.stringify({
      date: selectedDate,
      solat: selectedPrayer,
      value
    })
  });
}

async function loadDetail(){
  const r = await fetch(`${API}?mode=detail&date=${selectedDate}`,{cache:"no-store"});
  const d = await r.json();
  localData = d;
  renderDaily();
  log("Detail loaded");
}

async function loadHeatmap(){
  const r = await fetch(`${API}?mode=summary`,{cache:"no-store"});
  const d = await r.json();
  const hm = document.getElementById("heatmap");
  hm.innerHTML = "";
  PRAYERS.forEach(p=>{
    hm.innerHTML += `<div class="hm-label">${p}</div>`;
    d.days.forEach(day=>{
      const v = day[p] ?? 4;
      hm.innerHTML += `<div class="hm-cell ${COLOR[v]}"></div>`;
    });
  });
}

function init(){
  document.getElementById("todayLabel").innerText =
    new Date(selectedDate).toLocaleDateString("ms-MY",{weekday:"long", day:"numeric", month:"long", year:"numeric"});
  loadDetail();
  loadHeatmap();
}

init();
</script>
</body>
</html>
