<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Solat Tracker</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f2f2f2;
}
.container{
  max-width:420px;
  margin:0 auto;
  padding:16px;
}
h1{text-align:center;margin-bottom:4px}
.date-title{text-align:center;color:#666;margin-bottom:16px}

.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 0;
  border-bottom:1px solid #eee;
}
.row:last-child{border-bottom:none}

.pill{
  padding:6px 14px;
  border-radius:999px;
  font-size:14px;
  color:#fff;
  cursor:pointer;
}
.grey{background:#aaa}
.red{background:#e74c3c}
.yellow{background:#f1c40f;color:#000}
.green{background:#2ecc71}

.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.hidden{display:none}

.popup-box{
  background:#fff;
  border-radius:16px;
  padding:16px;
  width:90%;
  max-width:320px;
}
.popup-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.popup-btn{
  padding:12px;
  border:none;
  border-radius:12px;
  font-size:14px;
  cursor:pointer;
}
.cancel{
  margin-top:12px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
}

.heatmap-wrap{
  overflow-x:auto;
}
.heatmap{
  display:grid;
  grid-template-columns:60px repeat(auto-fit,32px);
  gap:6px;
  align-items:center;
}
.hm-label{font-size:13px}
.hm-date{
  text-align:center;
  font-size:12px;
  color:#666;
}
.hm-cell{
  width:28px;
  height:28px;
  border-radius:6px;
}
</style>
</head>

<body>
<div class="container">
  <h1>Solat Tracker</h1>
  <div id="todayLabel" class="date-title"></div>

  <div class="card">
    <h3>Status Harian</h3>
    <div id="statusDate"></div>

    <div class="row"><span>Subuh</span><span id="subuh" class="pill grey" onclick="openPopup('subuh')">Belum</span></div>
    <div class="row"><span>Zohor</span><span id="zohor" class="pill grey" onclick="openPopup('zohor')">Belum</span></div>
    <div class="row"><span>Asar</span><span id="asar" class="pill grey" onclick="openPopup('asar')">Belum</span></div>
    <div class="row"><span>Maghrib</span><span id="maghrib" class="pill grey" onclick="openPopup('maghrib')">Belum</span></div>
    <div class="row"><span>Isyak</span><span id="isyak" class="pill grey" onclick="openPopup('isyak')">Belum</span></div>
  </div>

  <div class="card">
    <h3>Heatmap Solat</h3>
    <div class="heatmap-wrap">
      <div id="heatmap" class="heatmap"></div>
    </div>
  </div>
</div>

<!-- POPUP -->
<div id="popup" class="popup hidden">
  <div class="popup-box">
    <h3 id="popupTitle"></h3>
    <div class="popup-grid">
      <button class="popup-btn red" onclick="submit(0)">Tak</button>
      <button class="popup-btn yellow" onclick="submit(1)">Lewat</button>
      <button class="popup-btn green" onclick="submit(2)">Awal</button>
    </div>
    <button class="cancel" onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwHxXrDrvBx27NbzEeevxIkKYTVVrdEsxV83xxpO9lKHltN3SmvCiiAR3daFTmiJt2k/exec";

let currentDate=new Date().toISOString().slice(0,10);
let selectedSolat=null;

const label=["Tak","Lewat","Awal"];
const cls=["red","yellow","green"];

function setPill(id,val){
  const el=document.getElementById(id);
  if(val==null){el.textContent="Belum";el.className="pill grey";return}
  el.textContent=label[val];
  el.className="pill "+cls[val];
}

function openPopup(s){
  selectedSolat=s;
  document.getElementById("popupTitle").textContent=s.toUpperCase();
  document.getElementById("popup").classList.remove("hidden");
}
function closePopup(){
  document.getElementById("popup").classList.add("hidden");
}

async function submit(val){
  await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({date:currentDate,solat:selectedSolat,value:val})
  });
  closePopup();
  loadDetail();
  loadHeatmap();
}

async function loadDetail(){
  const r=await fetch(API+"?mode=detail&date="+currentDate);
  const d=await r.json();
  setPill("subuh",d.subuh);
  setPill("zohor",d.zohor);
  setPill("asar",d.asar);
  setPill("maghrib",d.maghrib);
  setPill("isyak",d.isyak);
}

async function loadHeatmap(){
  const res=await fetch(API+"?mode=summary");
  const sum=await res.json();

  const hm=document.getElementById("heatmap");
  hm.innerHTML="<div></div>";

  sum.days.forEach(d=>{
    hm.innerHTML+=`<div class="hm-date">${d.date.slice(8)}</div>`;
  });

  ["subuh","zohor","asar","maghrib","isyak"].forEach(s=>{
    hm.innerHTML+=`<div class="hm-label">${s}</div>`;
    sum.days.forEach(async d=>{
      const r=await fetch(API+"?mode=detail&date="+d.date);
      const det=await r.json();
      const v=det[s];
      const c=v==null?"#ccc":cls[v]=="red"?"#e74c3c":cls[v]=="yellow"?"#f1c40f":"#2ecc71";
      hm.innerHTML+=`<div class="hm-cell" style="background:${c}"></div>`;
    });
  });
}

function init(){
  document.getElementById("todayLabel").textContent=new Date().toLocaleDateString("ms-MY",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  document.getElementById("statusDate").textContent="Tarikh: "+currentDate;
  loadDetail();
  loadHeatmap();
}
init();
</script>
</body>
</html>
