<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
:root{
  --bg:#f2f2f2;
  --card:#fff;
  --line:#eaeaea;
  --shadow:0 2px 10px rgba(0,0,0,.08);

  --red:#e53935;
  --yellow:#fbc02d;
  --green:#43a047;
  --grey:#bdbdbd;
  --gold:#fdd835;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  background:var(--bg);
}

.wrap{
  max-width:520px;
  margin:16px auto;
  padding:0 14px 30px;
}

/* ====== HEATMAP ====== */
.hm-card{
  margin-top:16px;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:12px;
}

.hm-title{
  font-weight:800;
  margin-bottom:8px;
}

.hm-scroll{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

.hm-table{
  display:grid;
  grid-template-columns:70px auto;
  gap:8px;
}

.hm-labels{
  display:grid;
  grid-template-rows:repeat(5,30px);
  gap:6px;
  font-size:13px;
  font-weight:700;
  color:#555;
}

.hm-grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:30px;
  grid-template-rows:repeat(5,30px);
  gap:6px;
}

.hm-cell{
  width:30px;
  height:30px;
  border-radius:6px;
  background:#eee;
  cursor:pointer;
}

.hm-cell.red{background:var(--red);}
.hm-cell.yellow{background:var(--yellow);}
.hm-cell.green{background:var(--green);}
.hm-cell.grey{background:var(--grey);}

.hm-cell.jemaah{
  background:var(--green);
  position:relative;
}
.hm-cell.jemaah::after{
  content:"";
  position:absolute;
  left:4px; right:4px; bottom:4px;
  height:3px;
  background:var(--gold);
  border-radius:99px;
}

/* ===== POPUP ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.hidden{display:none;}

.popup{
  background:#fff;
  border-radius:16px;
  width:90%;
  max-width:360px;
  padding:14px;
}

.pop-title{
  font-weight:900;
  margin-bottom:10px;
}

.pop-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.btn{
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
}

.btn.red{background:var(--red);color:#fff;}
.btn.yellow{background:var(--yellow);}
.btn.green{background:var(--green);color:#fff;}
.btn.gold{background:var(--gold);}
.btn.cancel{
  width:100%;
  margin-top:10px;
  background:#ccc;
}
</style>
</head>

<body>
<div class="wrap">

  <!-- ðŸ”´ ATAS (DATE SELECTOR + STATUS HARIAN)
       â›”ï¸ KEKAL â€“ ANG GAP CODE AWAK SEDIA ADA -->

  <!-- ===== HEATMAP ===== -->
  <div class="hm-card">
    <div class="hm-title">Ringkasan Bulan</div>

    <div class="hm-scroll">
      <div class="hm-table">

        <div class="hm-labels">
          <div>Subuh</div>
          <div>Zohor</div>
          <div>Asar</div>
          <div>Maghrib</div>
          <div>Isyak</div>
        </div>

        <div class="hm-grid" id="heatmap"></div>

      </div>
    </div>
  </div>

</div>

<!-- POPUP -->
<div class="overlay hidden" id="overlay">
  <div class="popup">
    <div class="pop-title" id="popTitle"></div>
    <div class="pop-grid">
      <button class="btn red" onclick="setVal(0)">Tak Solat</button>
      <button class="btn yellow" onclick="setVal(1)">Lewat</button>
      <button class="btn green" onclick="setVal(2)">Awal</button>
      <button class="btn gold" onclick="setVal(3)">Jemaah</button>
    </div>
    <button class="btn cancel" onclick="closePop()">Cancel</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";
const PRAYERS=["subuh","zohor","asar","maghrib","isyak"];
const LABEL={subuh:"Subuh",zohor:"Zohor",asar:"Asar",maghrib:"Maghrib",isyak:"Isyak"};

let selDate=null;
let selSolat=null;

/* ===== HEATMAP ===== */
async function loadHeatmap(){
  const res=await fetch(`${API}?mode=summary`);
  const json=await res.json();
  const days=json.days||[];

  const grid=document.getElementById("heatmap");
  grid.innerHTML="";

  days.forEach(day=>{
    PRAYERS.forEach(p=>{
      const v=day[p] ?? 4;
      const cell=document.createElement("div");
      cell.className="hm-cell "+
        (v===0?"red":v===1?"yellow":v===2?"green":v===3?"jemaah":"grey");
      cell.onclick=()=>openPop(p,day.date);
      grid.appendChild(cell);
    });
  });
}

/* ===== POPUP ===== */
function openPop(solat,date){
  selSolat=solat;
  selDate=date;
  document.getElementById("popTitle").innerText=
    `${LABEL[solat]} â€” ${date}`;
  document.getElementById("overlay").classList.remove("hidden");
}
function closePop(){
  document.getElementById("overlay").classList.add("hidden");
}
async function setVal(v){
  await fetch(`${API}?mode=update&date=${selDate}&solat=${selSolat}&value=${v}`);
  closePop();
  loadHeatmap();
}

/* INIT */
loadHeatmap();
</script>
</body>
</html>