<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#f4f4f4;
}
.container{
  max-width:420px;
  margin:auto;
  padding:16px;
}
h1{
  text-align:center;
  margin-bottom:4px;
}
.date-text{
  text-align:center;
  color:#555;
  margin-bottom:12px;
}

/* ===== DATE PICKER ===== */
.date-box{
  background:#fff;
  padding:12px;
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  margin-bottom:12px;
}
.date-input{
  width:100%;
  padding:10px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ccc;
}

/* ===== DAILY STATUS ===== */
.card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);
  padding:12px;
}
.row{
  recall:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid #eee;
}
.row:last-child{border-bottom:none}

.pill{
  padding:6px 14px;
  border-radius:999px;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}
.grey{background:#9e9e9e}
.red{background:#e53935}
.yellow{background:#fbc02d;color:#000}
.green{background:#43a047}
.gold{background:#fdd835;color:#000}

/* ===== POPUP ===== */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.hidden{display:none}
.popup-box{
  background:#fff;
  width:85%;
  max-width:320px;
  padding:16px;
  border-radius:16px;
}
.popup-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.btn{
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}
.cancel{
  margin-top:12px;
  width:100%;
  padding:10px;
  border-radius:12px;
  border:none;
}

/* ===== HEATMAP ===== */
.hm-card{
  margin-top:16px;
  background:#fff;
  border-radius:16px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);
  padding:12px;
}
.hm-title{
  font-weight:800;
  margin-bottom:8px;
}
.hm-scroll{
  overflow-x:auto;
}
.hm-table{
  display:grid;
  grid-template-columns:70px auto;
  gap:8px;
}
.hm-labels{
  display:grid;
  grid-template-rows:repeat(5,28px);
  gap:6px;
  font-weight:700;
  font-size:13px;
}
.hm-grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:28px;
  grid-template-rows:repeat(5,28px);
  gap:6px;
}
.hm-cell{
  width:28px;
  height:28px;
  border-radius:6px;
  background:#e0e0e0;
}
.hm-cell.red{background:#e53935}
.hm-cell.yellow{background:#fbc02d}
.hm-cell.green{background:#43a047}
.hm-cell.jemaah{
  background:#43a047;
  position:relative;
}
.hm-cell.jemaah::after{
  content:"";
  position:absolute;
  left:4px;right:4px;bottom:4px;
  height:3px;
  background:#fdd835;
  border-radius:99px;
}

/* ===== DEBUG ===== */
.debug{
  margin-top:12px;
  background:#000;
  color:#0f0;
  font-family:monospace;
  font-size:12px;
  padding:8px;
  border-radius:10px;
  max-height:120px;
  overflow:auto;
}
</style>
</head>

<body>
<div class="container">
  <h1>Solat Tracker</h1>
  <div class="date-text" id="dateText"></div>

  <div class="date-box">
    <input type="date" id="datePicker" class="date-input">
  </div>

  <div class="card" id="dailyCard"></div>

  <div class="hm-card">
    <div class="hm-title">Ringkasan Solat</div>
    <div class="hm-scroll">
      <div class="hm-table">
        <div class="hm-labels">
          <div>Subuh</div>
          <div>Zohor</div>
          <div>Asar</div>
          <div>Maghrib</div>
          <div>Isyak</div>
        </div>
        <div class="hm-grid" id="heatmap"></div>
      </div>
    </div>
  </div>

  <div class="debug" id="debug"></div>
</div>

<div class="popup hidden" id="popup">
  <div class="popup-box">
    <h3 id="popupTitle"></h3>
    <div class="popup-grid">
      <button class="btn red" onclick="submitSolat(0)">Tak Solat</button>
      <button class="btn yellow" onclick="submitSolat(1)">Lewat</button>
      <button class="btn green" onclick="submitSolat(2)">Awal</button>
      <button class="btn gold" onclick="submitSolat(3)">Jemaah</button>
    </div>
    <button class="cancel" onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";
const PRAYERS=["subuh","zohor","asar","maghrib","isyak"];
let selectedSolat=null;
let selectedDate=today();

function log(msg){
  const d=document.getElementById("debug");
  d.innerHTML+=`[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  d.scrollTop=d.scrollHeight;
}

function today(){return new Date().toISOString().slice(0,10);}

function label(v){return["Tak","Lewat","Awal","Jemaah","Belum"][v]}

function pillClass(v){
  return["red","yellow","green","gold","grey"][v]
}

function openPopup(s){selectedSolat=s;document.getElementById("popupTitle").innerText=s.toUpperCase();document.getElementById("popup").classList.remove("hidden")}
function closePopup(){document.getElementById("popup").classList.add("hidden")}

async function submitSolat(val){
  log(`submit ${selectedSolat}=${val}`);
  await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({date:selectedDate,solat:selectedSolat,value:val})
  });
  closePopup();
  loadDay();
  loadHeatmap();
}

async function loadDay(){
  const res=await fetch(API+`?mode=detail&date=${selectedDate}`);
  const d=await res.json();
  const card=document.getElementById("dailyCard");
  card.innerHTML="";
  PRAYERS.forEach(p=>{
    const v=d[p]??4;
    card.innerHTML+=`
      <div class="row">
        <span>${p[0].toUpperCase()+p.slice(1)}</span>
        <span class="pill ${pillClass(v)}" onclick="openPopup('${p}')">${label(v)}</span>
      </div>`;
  });
}

async function loadHeatmap(){
  const res=await fetch(API+"?mode=summary");
  const data=await res.json();
  const grid=document.getElementById("heatmap");
  grid.innerHTML="";
  data.days.forEach(day=>{
    PRAYERS.forEach(p=>{
      const v=day[p]??4;
      grid.innerHTML+=`<div class="hm-cell ${pillClass(v)}"></div>`;
    });
  });
}

document.getElementById("datePicker").value=selectedDate;
document.getElementById("datePicker").onchange=e=>{
  selectedDate=e.target.value;
  loadDay();
};

document.getElementById("dateText").innerText=new Date().toLocaleDateString("ms-MY",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

loadDay();
loadHeatmap();
log("App loaded OK");
</script>
</body>
</html>