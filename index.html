<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solat Tracker</title>

<style>
:root{
  --bg:#f2f2f2;
  --card:#fff;
  --line:#eaeaea;
  --shadow:0 2px 10px rgba(0,0,0,.08);

  --red:#e53935;
  --yellow:#fbc02d;
  --green:#43a047;
  --gold:#fdd835;
  --grey:#9e9e9e;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  background:var(--bg);
}

.wrap{
  max-width:520px;
  margin:18px auto;
  padding:0 14px 20px;
}

h2{
  text-align:center;
  margin:8px 0 4px;
}
#prettyDate{
  text-align:center;
  color:#666;
  margin-bottom:10px;
}

/* ===== DAILY CARD ===== */
.card{
  background:var(--card);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-bottom:1px solid var(--line);
}
.row:last-child{border-bottom:none;}
.name{font-weight:700;}
.pill{
  min-width:86px;
  text-align:center;
  padding:6px 14px;
  border-radius:999px;
  color:#fff;
  font-size:13px;
  font-weight:800;
  cursor:pointer;
}
.grey{background:var(--grey);}
.red{background:var(--red);}
.yellow{background:var(--yellow);color:#000;}
.green{background:var(--green);}
.jemaah{
  background:var(--green);
  position:relative;
}
.jemaah::after{
  content:"";
  position:absolute;
  left:10px;right:10px;bottom:4px;
  height:3px;
  background:var(--gold);
  border-radius:99px;
}

/* ===== HEATMAP CARD ===== */
.hm-card{
  margin-top:14px;
  background:var(--card);
  border-radius:14px;
  box-shadow:var(--shadow);
  padding:10px 10px 12px;
}
.hm-title{
  font-weight:800;
  font-size:14px;
  margin:2px 4px 8px;
}
.hm-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.hm-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(28px,1fr));
  gap:6px;
}
.hm-col{
  display:grid;
  grid-template-rows:repeat(5,28px);
  gap:6px;
}
.hm-cell{
  width:28px;
  height:28px;
  border-radius:6px;
  background:#eee;
  cursor:pointer;
}
.hm-cell.red{background:var(--red);}
.hm-cell.yellow{background:var(--yellow);}
.hm-cell.green{background:var(--green);}
.hm-cell.grey{background:#ddd;}
.hm-cell.jemaah{
  background:var(--green);
  position:relative;
}
.hm-cell.jemaah::after{
  content:"";
  position:absolute;
  left:4px;right:4px;bottom:3px;
  height:3px;
  background:var(--gold);
  border-radius:99px;
}
.hm-labels{
  display:grid;
  grid-template-rows:repeat(5,28px);
  gap:6px;
  margin-right:8px;
}
.hm-labels div{
  font-size:12px;
  color:#555;
  display:flex;
  align-items:center;
}

/* ===== POPUP ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.hidden{display:none;}
.popup{
  background:#fff;
  border-radius:16px;
  width:90%;
  max-width:360px;
  padding:14px;
}
.pop-title{
  font-weight:900;
  margin-bottom:10px;
}
.pop-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.btn{
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
}
.btn.red{background:var(--red);color:#fff;}
.btn.yellow{background:var(--yellow);}
.btn.green{background:var(--green);color:#fff;}
.btn.gold{background:var(--gold);}
.btn.cancel{
  width:100%;
  margin-top:10px;
  background:#ccc;
}
</style>
</head>

<body>
<div class="wrap">
  <h2>Solat Tracker</h2>
  <div id="prettyDate"></div>

  <!-- DAILY -->
  <div class="card" id="dailyCard"></div>

  <!-- HEATMAP -->
  <div class="hm-card">
    <div class="hm-title">Heatmap Bulan Ini</div>
    <div style="display:flex">
      <div class="hm-labels">
        <div>Subuh</div>
        <div>Zohor</div>
        <div>Asar</div>
        <div>Magh</div>
        <div>Isyak</div>
      </div>
      <div class="hm-wrap">
        <div class="hm-grid" id="heatmap"></div>
      </div>
    </div>
  </div>
</div>

<!-- POPUP -->
<div class="overlay hidden" id="overlay">
  <div class="popup">
    <div class="pop-title" id="popTitle"></div>
    <div class="pop-grid">
      <button class="btn red" onclick="setVal(0)">Tak Solat</button>
      <button class="btn yellow" onclick="setVal(1)">Lewat</button>
      <button class="btn green" onclick="setVal(2)">Awal</button>
      <button class="btn gold" onclick="setVal(3)">Jemaah</button>
    </div>
    <button class="btn cancel" onclick="closePop()">Cancel</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwRxMoxud-Rsn__BoiKQyOtPc9M0n-Q-gCUmDFVkUhUmSXdCyagCb5JruxUEDzA8ulq/exec";
const PRAYERS=["subuh","zohor","asar","maghrib","isyak"];
const LABEL={subuh:"Subuh",zohor:"Zohor",asar:"Asar",maghrib:"Maghrib",isyak:"Isyak"};

let curDate=new Date();
let selDateISO=iso(curDate);
let selSolat=null;

/* ===== helpers ===== */
function iso(d){
  return d.toISOString().slice(0,10);
}
function pretty(d){
  return d.toLocaleDateString("ms-MY",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}

/* ===== DAILY ===== */
async function loadDay(dateISO){
  const r=await fetch(`${API}?mode=detail&date=${dateISO}`);
  const d=await r.json();
  const box=document.getElementById("dailyCard");
  box.innerHTML="";
  PRAYERS.forEach(p=>{
    const v=Number(d[p]??4);
    const pillClass = v===0?"red":v===1?"yellow":v===2?"green":v===3?"jemaah":"grey";
    const text = v===0?"Tak":v===1?"Lewat":v===2?"Awal":v===3?"Jemaah":"Belum";
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="name">${LABEL[p]}</div>
      <div class="pill ${pillClass}" onclick="openPop('${p}','${dateISO}')">${text}</div>
    `;
    box.appendChild(row);
  });
}

/* ===== HEATMAP ===== */
async function loadHeatmap(){
  const r=await fetch(`${API}?mode=summary`);
  const data=(await r.json()).days||[];
  const map=document.getElementById("heatmap");
  map.innerHTML="";
  data.forEach(day=>{
    const col=document.createElement("div");
    col.className="hm-col";
    PRAYERS.forEach(p=>{
      const v=day[p] ?? day.status ?? 4;
      const c=document.createElement("div");
      c.className="hm-cell "+
        (v===0?"red":v===1?"yellow":v===2?"green":v===3?"jemaah":"grey");
      c.onclick=()=>openPop(p,day.date);
      col.appendChild(c);
    });
    map.appendChild(col);
  });
}

/* ===== POPUP ===== */
function openPop(solat,dateISO){
  selSolat=solat;
  selDateISO=dateISO;
  document.getElementById("popTitle").innerText=
    `${LABEL[solat]} â€” ${dateISO}`;
  document.getElementById("overlay").classList.remove("hidden");
}
function closePop(){
  document.getElementById("overlay").classList.add("hidden");
}
async function setVal(v){
  await fetch(`${API}?mode=update&date=${selDateISO}&solat=${selSolat}&value=${v}`);
  closePop();
  loadDay(selDateISO);
  loadHeatmap();
}

/* ===== INIT ===== */
document.getElementById("prettyDate").innerText=pretty(curDate);
loadDay(selDateISO);
loadHeatmap();
</script>
</body>
</html>